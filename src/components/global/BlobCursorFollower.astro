---
/* CursorBlob.astro - Efecto de luz ambiental que sigue al ratón */
---

<div id="cursor-follower" class="pointer-events-none fixed inset-0 z-0">
    <div id="blob" class="blob"></div>
</div>

<script>
    import { gsap } from "gsap";

    function init() {
        // Detectar si es táctil para no ejecutar innecesariamente
        const isTouchDevice = window.matchMedia("(hover: none)").matches;
        if (isTouchDevice) return;

        const blob = document.getElementById("blob");
        const follower = document.getElementById("cursor-follower");

        if (!blob || !follower) return;

        // Variables de posición
        let mouseX = 0;
        let mouseY = 0;
        let currentX = 0;
        let currentY = 0;

        // Factor de suavizado (0.08 es una estela elegante)
        const lerpFactor = 0.08; 

        const handleMouseMove = (e: MouseEvent) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        };

        window.addEventListener("mousemove", handleMouseMove);

        // Loop de animación con rAF
        let animationFrameId: number;
        function update() {
            currentX += (mouseX - currentX) * lerpFactor;
            currentY += (mouseY - currentY) * lerpFactor;

            gsap.set(blob, {
                x: currentX,
                y: currentY,
                xPercent: -50,
                yPercent: -50
            });

            animationFrameId = requestAnimationFrame(update);
        }

        update();

        // Manejo de elementos interactivos
        const refreshInteractions = () => {
            const interactiveElements = document.querySelectorAll("[data-cursor-hover]");

            interactiveElements.forEach((el) => {
                // Efecto de expansión del blob
                el.addEventListener("mouseenter", () => {
                    gsap.to(blob, {
                        scale: 1.8,
                        opacity: 0.35,
                        duration: 0.8,
                        ease: "power2.out"
                    });
                });

                el.addEventListener("mouseleave", () => {
                    gsap.to(blob, {
                        scale: 1,
                        opacity: 0.2,
                        duration: 0.8,
                        ease: "power2.out"
                    });

                    if (el.hasAttribute("data-cursor-parallax")) {
                        gsap.to(el, { x: 0, y: 0, duration: 0.6, ease: "power3.out" });
                    }
                });

                // Efecto Parallax / Magnético
                el.addEventListener("mousemove", (e) => {
                    if (el instanceof HTMLElement && el.hasAttribute("data-cursor-parallax")) {
                        const rect = el.getBoundingClientRect();
                        const x = ((e as MouseEvent).clientX - (rect.left + rect.width / 2)) * 0.25;
                        const y = ((e as MouseEvent).clientY - (rect.top + rect.height / 2)) * 0.25;
                        
                        gsap.to(el, {
                            x: x,
                            y: y,
                            duration: 0.4,
                            ease: "power2.out"
                        });
                    }
                });
            });
        };

        refreshInteractions();
        follower.classList.add("active");

        // Cleanup para Astro View Transitions
        document.addEventListener("astro:before-swap", () => {
            window.removeEventListener("mousemove", handleMouseMove);
            cancelAnimationFrame(animationFrameId);
        }, { once: true });
    }

    // Inicialización robusta
    document.addEventListener("astro:page-load", init);
</script>

<style>
    #cursor-follower {
        opacity: 0;
        transition: opacity 1.5s ease-in-out;
        z-index: 1; /* Por encima del fondo, por debajo del contenido */
    }

    #cursor-follower.active {
        opacity: 1;
    }

    .blob {
        position: fixed;
        top: 0;
        left: 0;
        width: 35vw; /* Tamaño dinámico basado en pantalla */
        height: 35vw;
        max-width: 500px;
        max-height: 500px;
        background-color: #a3e635; /* Lima Vantta */
        border-radius: 50%;
        filter: blur(120px); /* Blur aumentado para efecto más difuso */
        opacity: 20%;
        pointer-events: none;
        will-change: transform;
        mix-blend-mode: screen; /* Mezcla mejor en fondos oscuros */
    }
</style>