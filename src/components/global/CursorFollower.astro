---
/* src/components/global/CursorFollower.astro */
---
<div id="cursor-container">
    <div id="cursor-follower"></div>
    <div id="cursor-dot"></div>
</div>

<style is:global>
    /* Desactivar cursor real solo en dispositivos con puntero (no táctiles) */
    @media (hover: hover) and (pointer: fine) {
        html, body, a, button, [data-cursor-hover] {
            cursor: none !important;
        }

        #cursor-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 99999;
        }

        #cursor-follower {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 1.5px solid #a3e635; /* Verde Lima */
            border-radius: 50%;
            pointer-events: none;
            left: 0;
            top: 0;
            opacity: 0;
            z-index: 99999;
            will-change: transform;
            /* El mix-blend-mode exclusion hace que el cursor sea legible sobre cualquier color */
            mix-blend-mode: exclusion;
        }

        #cursor-dot {
            position: fixed;
            width: 6px;
            height: 6px;
            background-color: #a3e635;
            border-radius: 50%;
            pointer-events: none;
            left: 0;
            top: 0;
            opacity: 0;
            z-index: 100000;
            will-change: transform;
        }

        /* Estados de animación del follower */
        .cursor-active #cursor-follower {
            width: 80px;
            height: 80px;
            background-color: #a3e635;
            border-color: transparent;
            opacity: 1 !important;
        }

        /* Cambiamos el punto cuando está activo */
        .cursor-active #cursor-dot {
            opacity: 0 !important;
        }
    }

    /* Ocultar en dispositivos táctiles */
    @media (hover: none) {
        #cursor-container { display: none; }
    }
</style>

<script>
    import { gsap } from "gsap";

    function initCursor() {
        const follower = document.getElementById('cursor-follower');
        const dot = document.getElementById('cursor-dot');
        
        if (!follower || !dot) return;

        // Posicionamiento inicial
        gsap.set([follower, dot], { xPercent: -50, yPercent: -50 });

        const moveCursor = (e: MouseEvent) => {
            const { clientX: x, clientY: y } = e;

            // El punto (dot) es instantáneo
            gsap.to(dot, {
                x: x,
                y: y,
                duration: 0,
                opacity: 1
            });

            // El seguidor (follower) tiene un delay suave (0.15s) para el efecto orgánico
            gsap.to(follower, {
                x: x,
                y: y,
                duration: 0.5,
                ease: "power3.out",
                opacity: 1
            });
        };

        window.addEventListener('mousemove', moveCursor);

        // Lógica de Hovers mejorada
        const handleMouseEnter = () => document.body.classList.add('cursor-active');
        const handleMouseLeave = () => document.body.classList.remove('cursor-active');

        const refreshLinks = () => {
            // Buscamos links, botones y cualquier cosa con el atributo que usamos en el footer/header
            const targets = document.querySelectorAll('a, button, [data-cursor-hover], .nav-container');
            targets.forEach(target => {
                target.addEventListener('mouseenter', handleMouseEnter);
                target.addEventListener('mouseleave', handleMouseLeave);
            });
        };

        refreshLinks();

        // Limpieza para evitar fugas de memoria en Astro
        document.addEventListener("astro:before-swap", () => {
            window.removeEventListener('mousemove', moveCursor);
            document.body.classList.remove('cursor-active');
        }, { once: true });
    }

    // Ejecución inicial y en cada transición de página
    document.addEventListener("astro:page-load", initCursor);
</script>