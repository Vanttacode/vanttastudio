---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseLayout from "@layouts/BaseLayout.astro";
import Title from "@components/global/Title.astro";
import { getLangFromUrl, useTranslations, useTranslatedPath } from "@i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const allProjects = (await getCollection("projects"))
    .filter((project) => {
        const [projectLang] = project.slug.split("/");
        return projectLang === lang;
    })
    .map((project) => {
        const [_, ...slugParts] = project.slug.split("/");
        return { ...project, slug: slugParts.join("/") };
    });

// EXTRAER CATEGORÍAS BASADAS EN EL PRIMER TAG (Para el filtro)
const categories = [...new Set(allProjects.map((project) => project.data.tags?.[0]))].filter(Boolean);

const seo = {
    title: "Portfolio | Vantta Studio",
    description: "Digital Portfolio and Selected Works",
};
---

<BaseLayout seo={seo}>
    <section class="bg-zinc-950 text-white min-h-screen">
        <div class="mx-auto px-8 pt-32 pb-12 md:px-12 2xl:max-w-7xl">
            <div class="max-w-3xl">
                <span class="font-mono text-[10px] uppercase tracking-[0.5em] text-lime-400 mb-4 block">
                    Selected Works
                </span>
                <Title 
                    title="PORTFOLIO" 
                    class="text-6xl md:text-8xl lg:text-9xl font-black uppercase tracking-tighter italic leading-[0.8]" 
                />
            </div>
        </div>

        <div class="bg-zinc-950 border-y border-zinc-900">
            <div class="mx-auto px-8 py-8 md:px-12 2xl:max-w-7xl">
                <nav class="flex flex-wrap items-center justify-center md:justify-start gap-x-10 gap-y-4">
                    <button 
                        data-filter="all" 
                        class="filter-btn active font-mono text-[11px] uppercase tracking-[0.2em] text-lime-400 transition-all hover:text-white"
                    >
                        [ All ]
                    </button>
                    
                    {categories.map((cat) => (
                        <button 
                            data-filter={cat.toLowerCase().replace(/\s+/g, '-')} 
                            class="filter-btn font-mono text-[11px] uppercase tracking-[0.2em] text-zinc-500 transition-all hover:text-white"
                        >
                            {cat}
                        </button>
                    ))}
                </nav>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 w-full border-t border-zinc-900" id="portfolio-grid">
            {allProjects.map((project) => {
                // Adaptado a tu esquema: project.data.image.source
                const projectImage = project.data.image?.source;
                // Usamos el primer tag para la lógica de filtrado
                const firstTag = project.data.tags?.[0] || "Creative";
                const filterTag = firstTag.toLowerCase().replace(/\s+/g, '-');
                
                return (
                    <a 
                        href={translatePath(`/work/${project.slug}`)} 
                        data-category={filterTag}
                        class="portfolio-item group relative aspect-[4/3] overflow-hidden bg-zinc-900 block border-b border-r border-zinc-900 transition-all duration-500"
                    >
                        <div class="absolute inset-0 h-full w-full overflow-hidden">
                            {projectImage ? (
                                <Image 
                                    src={projectImage} 
                                    alt={project.data.image.alt || project.data.title}
                                    width={800}
                                    height={600}
                                    class="h-full w-full object-cover transition-transform duration-1000 ease-out group-hover:scale-110"
                                />
                            ) : (
                                <div class="flex h-full w-full items-center justify-center bg-zinc-900 text-zinc-800 font-mono text-[10px]">
                                    NO_IMAGE
                                </div>
                            )}
                            <div class="absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                        </div>

                        <div class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center z-20">
                            <span class="font-mono text-[10px] uppercase tracking-[0.3em] text-lime-400 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500 delay-75">
                                {firstTag}
                            </span>
                            <h3 class="mt-4 text-3xl md:text-4xl font-black uppercase tracking-tighter italic leading-none translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500 delay-150">
                                {project.data.title}
                            </h3>
                            <div class="mt-6 h-[1px] w-0 bg-white group-hover:w-12 transition-all duration-700 delay-300"></div>
                            <span class="mt-4 font-mono text-[8px] uppercase tracking-widest opacity-0 group-hover:opacity-60 transition-all duration-700 delay-500">
                                View Case
                            </span>
                        </div>
                    </a>
                );
            })}
        </div>
    </section>
</BaseLayout>

<script>
    function setupPortfolioFilters() {
        const buttons = document.querySelectorAll('.filter-btn');
        const items = document.querySelectorAll('.portfolio-item') as NodeListOf<HTMLElement>;

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                // UI: Update button states
                buttons.forEach(b => {
                    b.classList.remove('text-lime-400', 'active');
                    b.classList.add('text-zinc-500');
                });
                btn.classList.add('text-lime-400', 'active');
                btn.classList.remove('text-zinc-500');

                const filter = btn.getAttribute('data-filter');

                items.forEach(item => {
                    const category = item.getAttribute('data-category');
                    if (filter === 'all' || filter === category) {
                        item.style.display = 'block';
                        setTimeout(() => {
                            item.style.opacity = '1';
                            item.style.transform = 'scale(1)';
                        }, 10);
                    } else {
                        item.style.opacity = '0';
                        item.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            item.style.display = 'none';
                        }, 400);
                    }
                });
            });
        });
    }

    // Initialize
    setupPortfolioFilters();
    // Re-run for Astro View Transitions
    document.addEventListener('astro:after-swap', setupPortfolioFilters);
</script>

<style>
    .portfolio-item {
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .filter-btn.active {
        pointer-events: none;
    }
</style>